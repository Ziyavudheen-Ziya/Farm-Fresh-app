
<%- include('../adminpartials/adminheader') %>




    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery and Validation Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.20.0/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.20.0/additional-methods.min.js"></script>


<style>
    .pt-3 {
    padding-top: 1rem !important;
    margin-inline: -201px;
}
</style>


<main class="main-wrap">
    <!-- <header class="main-header navbar">
        <div class="col-search">
            <form class="searchform">
                <div class="input-group">
                    <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                    <button class="btn btn-light bg" type="button"> <i
                            class="material-icons md-search"></i></button>
                </div>
                <datalist id="search_terms">
                    <option value="Products">
                    <option value="New orders">
                    <option value="Apple iphone">
                    <option value="Ahmed Hassan">
                </datalist>
            </form>
        </div>
        
    </header> -->
<br>
<br>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-6 text-center">
                <h4 style="padding-right: 320px;">Coupon Management</h4>
            </div>
            <br>
            <div class="col-4 text-end">
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#exampleModal">
                    Add new coupon
                </button>
            </div>
        </div>
    </div>

    <!-- Add Coupon Modal start-->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add New Coupon</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addCouponForm" role="form">
                    <div class="modal-body">
                        <div class="couponCodeInput p-2">
                            <label for="couponCode" class="mb-2">Coupon Code: </label>
                            <div class="input-group">
                                <input style="width: 100%;" id="couponCode" name="couponCode" title="Enter a valid coupon code" type="text"
                                       class="form-control" placeholder="Enter coupon code" required minlength="5"
                                       maxlength="16" />
                            </div>
                            <div class="form-text">
                                Add a relevant coupon code eg: NEWYEAR2024, PONGAL2024, VYZ548
                            </div>
                            <span id="couponCodeError" class="error"></span>
                        </div>
                        <div class="discountPercentageInput p-2">
                            <label for="coupanAmount" class="mb-2">Coupon Amount: </label>
                            <div class="input-group">
                                <input style="width: 100%;" id="coupanAmount" name="coupanAmount" type="number" min="1" 
                                       class="form-control" placeholder="Enter discount percentage" required />
                            </div>
                            <div class="form-text">
                                Choose a percentage to be discounted. Between 5% and 90%.
                            </div>
                        </div>
                        <div class="startDateInput p-2">
                            <label for="startDate">Coupon Start Date: </label>
                            <div class="input-group">
                                <input style="width: 100%;" id="startDate" name="startDate" type="date" class="form-control" required />
                            </div>
                            <div class="form-text">
                                Choose a start date for the discount to be considered.
                            </div>
                        </div>
                        <div class="expiryDateInput p-2">
                            <label for="expiryDate">Coupon Expiry Date: </label>
                            <div class="input-group">
                                <input style="width: 100%;" id="expiryDate" name="expiryDate" type="date" class="form-control" required />
                            </div>
                            <div class="form-text">
                                Choose an expiry date for the discount to end.
                            </div>
                        </div>
                        <div class="minimumPurchaseInput p-2">
                            <label for="minimumPurchase">Minimum Purchase: </label>
                            <div class="input-group">
                                <input style="width: 100%;" id="minimumPurchase" name="minimumPurchase" type="number" class="form-control"
                                       placeholder="Enter minimum purchase required" required min="1" />
                            </div>
                            <div class="form-text">
                                Minimum amount of purchase to be done to allow the coupon discount.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Close
                        </button>
                        <button id="addCouponBtn" type="submit" class="btn btn-info">
                            Save changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

      <!-- Addcoupan ending -->







    <div class="container pt-3">
        <table id="example" class="table table-bordered table-striped">
            <thead class="thead-dark">
                <tr>
                    <th scope="col" class="text-center">S No</th>
                    <th scope="col" class="text-center">Coupon Code</th>
                    <th scope="col" class="text-center">Coupan Amount</th>
                    <th scope="col" class="text-center">Start Date</th>
                    <th scope="col" class="text-center">Expiry Date</th>
                    <th scope="col" class="text-center">Minimum Purchase</th>
                    <!-- <th scope="col" class="text-center">Maximum Purchase</th> -->
                    <th scope="col" class="text-center">Current Status</th>
                </tr>
            </thead>
            <tbody>

               <% coupanData.forEach((data,index)=>{ %>


              
                    <tr>
                        <td class="text-center">

                            <%=index+1%>
                            
                        </td>
                        <td id="coupanCode">
                       
                            <%=data.coupanCode%>

                           
                        </td>
                        <td class="text-center" id="coupanAmount">
                            <%=data.coupanAmount%>

                        </td>
                        <td class="text-center" id="startDate">

                            <%=data.startDate%>
                            
                        </td>
                        <td class="text-center"  id="expiryDate">
                            <%=data.expiryDate%>
                        </td>
                        <td class="text-center" id="minimumPurchase">₹:<%=data.minimumPurchase%>
                        </td>
                        <!-- <td class="text-center">₹ 
                        </td> -->
                        <td class="text-center">
                            <a href="/coupan?id=<%=data.id%>" onclick="coupanId('<%=data.id%>')" class="btn btn-info" data-bs-toggle="modal"
                                data-bs-target="#editModal">Edit <i class="fas fa-edit"></i></a>
                            
                        </button>


                        <button type="button"  onclick="coupanDelete('<%=data.id%>')" class="btn btn-danger" >Delete</button>
                        </td>
                    </tr>

                    <% }) %>

            </tbody>
        </table>
    </div>



       <!-- ======================Edit starting============================= -->

       <%coupanData.forEach((data)=>{%>

  
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Edit Coupon</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                  

                
                    <form id="editCoupanForm">
                        <div class="modal-body">
                            <div class="couponCodeInput p-2">
                                <label for="" class="mb-2">Coupon Code: </label>
                                <div class="input-group">
                                    <input style="width: 100%;"  id="coupanCode" name="couponCode" type="text"
                                        class="form-control " value="<%=data.coupanCode%>" required  minlength="5"
                                        maxlength="16" disabled >

                                </div>
                                <div class="form-text">Add a relevant coupon code e.g.: NEWYEAR2024, PONGAL2024, VYZ548
                                </div>
                            </div>

                            <div class="discountPercentageInput p-2">
                                <label for="" class="mb-2">Coupan Amount:
                                </label>
                                <div class="input-group">
                                    <input style="width: 100%;"  id="coupanAmount" name="coupanAmount" type="number"
                                        class="form-control" value="<%=data.coupanAmount%>" required min="1">
                                </div>
                                <div class="form-text">Choose a percentage to be discounted. Between 5% and 90%.</div>
                            </div>

                            <div class="startDateInput p-2">
                                <label for="">Coupon Start Date:</label>
                                <div class="input-group">
                                    <input style="width: 100%;" id="startDate" name="startDate" type="date"
                                        class="form-control" value="<%=data.startDate.toISOString().split('T')[0]%>" required>
                                </div>
                                <div class="form-text">Choose a start date for the discount to be considered.</div>
                            </div>

                            <div class="expiryDateInput p-2">
                                <label for="">Coupon Expiry Date: </label>
                                <div class="input-group">
                                    <input style="width: 100%;"  id="expiryDate" name="expiryDate" type="date"
                                        class="form-control" value="<%=data.expiryDate.toISOString().split('T')[0]%>" required>
                                </div>
                                <div class="form-text">Choose an expiry date for the discount to end.</div>
                            </div>

                            <div class="minimumPurchaseInput p-2">
                                <label for="">Minimum Purchase: </label>
                                <div class="input-group">
                                    <input style="width: 100%;"  id="" name="minimumPurchase" type="number"
                                        class="form-control" placeholder="Enter minimum purchase required"
                                        value="<%=data.minimumPurchase%>" required min="1">
                                </div>
                                <div class="form-text">Minimum amount of purchase to be done to allow the coupon
                                    discount.</div>
                            </div>

                            <!-- maximum amount side -->

                            <!-- <div class="maximumDiscount p-2">
                                <label for="">Maximum Purchase: </label>
                                <div class="input-group">
                                    <input style="width: 100%;" id="" name="maximumDiscount" type="number"
                                        class="form-control" placeholder="Maximum discount applicable"
                                        value="" required min="1">
                                </div>
                                <div class="form-text">Maximum amount of discount to be allowed while using the coupon.
                                </div>
                            </div> -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-info">Save changes</button>
                        </div>
                    </form>

                  
                </div>
            </div>
        </div>




        <!-- =========================Edit page ending================== -->
        <script>

            let currentCouponId = null;
            function coupanId(couponId) {
            
               
                currentCouponId = couponId;
            
            
                $('#editModal').modal('show');
            }
            

            
                
                $(document).ready(function(){
            
                    console.log("entering");
            
                     $('#editCoupanForm').validate({
            
                           rules:{
                            
                            couponCode:{
                                required:true
                            },
                            coupanAmount:{
                                required:true,
                                digits:true
                            },
                            minimumPurchase:{
                                required:true,
                                digits:true
                            }
            
                             
                           },
            
                           submitHandler:async function(form,event){
            
                                 event.preventDefault()
            
                                 let formData = {
            
                                      couponCode:form.couponCode.value,
                                      coupanAmount:form.coupanAmount.value,
                                      minimumPurchase:form.minimumPurchase.value,
                                      startDate:form.startDate.value,
                                      expiryDate:form.expiryDate.value
                                 }
            
            
                                 let response = await fetch(`/editCoupan?id=${currentCouponId}`,{
            
                                        
                                        method:"POST",
                                        headers:{'Content-Type':'application/json'},
                                        body:JSON.stringify(formData)
                                 })
            
                                 let result = await response.json()
            
            
                                 if(result.success){
            
                                     await Swal.fire({
            
                                         icon:"success",
                                         title:"Coupan Edited"
                                     })
            
                                     window.location.href='/coupan'
                                 }

                                 if(result.coupanIsNotAVialable){

                                    await Swal.fire({

                                         icon:"error",
                                         title:"Alredy Exsist"
                                    })

                                    window.location.reload()
                                 }
            
                                 
                           }
                     })
                })
            
            
            </script>
            
        
       <% })%>

       <script>
         
         async function coupanDelete(coupanId){

             let response = await fetch(`/deleteCoupan?id=${coupanId}`,{

                 method:"DELETE",
                 headers:{'Content-Type':'application/json'}
             })

             let result = await response.json()

             if(result.deleted){

                await Swal.fire({
                     icon:"success",
                     title:"Coupan Deleted"
                })

                window.location.reload()
             }
         }
       </script>

<div class="d-flex justify-content-center py-3">
    <nav aria-label="Page navigation example">
        <ul class="pagination">
            <li class="page-item"><a class="page-link">Pages</a></li>

            <%for(let i=0;i<totalPages;i++){%>

                <li class="page-item">
                  


                 
                    <a class="page-link" href="/coupan?pageNo=<%=i+1%>"><%=i+1%> </a>
                </li>
            <%}%>
             
        </ul>

</div>
       

        <div>
            <br/><br/><br><br><br>
        </div>

      
    

            
<allScripts>


            



<style>
    .error {
        color: red;
        display: block; /* Make the error message appear as a block element */
        margin-top: 5px; 
    }
</style>



</allScripts>
<!-- <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script> -->
<!-- 
<script>
  $(document).ready( function () {
      $('#example').DataTable();
  } );
  </script>
<script src="/assets1/js/vendors/bootstrap.bundle.min.js"></script>
<script src="/assets1/js/vendors/select2.min.js"></script>
<script src="/assets1/js/vendors/perfect-scrollbar.js"></script>
<script src="/assets1/js/vendors/jquery.fullscreen.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.2/dist/sweetalert2.all.min.js"></script>

<!-- Main Script -->
<!-- <script src="/assets1/js/main.js" type="text/javascript"></script> -->
</body>


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
    $(document).ready(function() {
        $('#addCouponForm').validate({
            rules: {
                couponCode: {
                    required: true
                },
                coupanAmount: {
                    required: true,
                    digits: true
                },
                minimumPurchase: {
                    required: true,
                    digits: true
                }
            },
            submitHandler: async function(form, event) {
                event.preventDefault();

                let formData = {
                    couponCode: form.couponCode.value,
                    coupanAmount: form.coupanAmount.value,
                    minimumPurchase: form.minimumPurchase.value,
                    startDate: form.startDate.value,
                    expiryDate: form.expiryDate.value
                };

                try {
                    let response = await fetch('/addCoupan', {
                        method: "POST",
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(formData)
                    });

                    let result = await response.json();

                    if (result.success) {
                        await Swal.fire({
                            icon: "success",
                            title: "Coupon Added"
                        });
                        window.location.reload();
                    } 

                    if(result.alreadyExsist){

                        await Swal.fire({
                            icon:"error",
                            title:"Already Exsisit"
                        })
                    }
                } catch (error) {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: error.message
                    });
                }
            }
        });
    });
</script>





<!-- Mirrored from wp.alithemes.com/html/evara/evara-backend/page-form-product-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Aug 2021 15:33:32 GMT -->
</html>
<%- include('../adminpartials/adminfooter') %>
